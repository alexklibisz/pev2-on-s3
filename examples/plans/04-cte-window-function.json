{
  "title": "Customer spending ranks with percentiles",
  "query": "-- Customer spending ranks with percentiles\nWITH customer_totals AS (\n  SELECT\n    c.id,\n    c.name,\n    c.city,\n    COUNT(o.id) AS order_count,\n    COALESCE(SUM(o.total), 0) AS total_spent\n  FROM customers c\n  LEFT JOIN orders o ON o.customer_id = c.id\n  GROUP BY c.id, c.name, c.city\n)\nSELECT\n  name,\n  city,\n  order_count,\n  total_spent,\n  RANK() OVER (ORDER BY total_spent DESC) AS spending_rank,\n  NTILE(100) OVER (ORDER BY total_spent DESC) AS percentile\nFROM customer_totals\nORDER BY total_spent DESC\nLIMIT 20;",
  "plan": "[\n  {\n    \"Plan\": {\n      \"Node Type\": \"Limit\",\n      \"Parallel Aware\": false,\n      \"Async Capable\": false,\n      \"Startup Cost\": 2631.71,\n      \"Total Cost\": 2632.11,\n      \"Plan Rows\": 20,\n      \"Plan Width\": 74,\n      \"Actual Startup Time\": 24.984,\n      \"Actual Total Time\": 24.993,\n      \"Actual Rows\": 20,\n      \"Actual Loops\": 1,\n      \"Shared Hit Blocks\": 402,\n      \"Shared Read Blocks\": 112,\n      \"Shared Dirtied Blocks\": 0,\n      \"Shared Written Blocks\": 0,\n      \"Local Hit Blocks\": 0,\n      \"Local Read Blocks\": 0,\n      \"Local Dirtied Blocks\": 0,\n      \"Local Written Blocks\": 0,\n      \"Temp Read Blocks\": 0,\n      \"Temp Written Blocks\": 0,\n      \"Plans\": [\n        {\n          \"Node Type\": \"WindowAgg\",\n          \"Parent Relationship\": \"Outer\",\n          \"Parallel Aware\": false,\n          \"Async Capable\": false,\n          \"Startup Cost\": 2631.71,\n          \"Total Cost\": 2831.69,\n          \"Plan Rows\": 10000,\n          \"Plan Width\": 74,\n          \"Actual Startup Time\": 24.983,\n          \"Actual Total Time\": 24.990,\n          \"Actual Rows\": 20,\n          \"Actual Loops\": 1,\n          \"Shared Hit Blocks\": 402,\n          \"Shared Read Blocks\": 112,\n          \"Shared Dirtied Blocks\": 0,\n          \"Shared Written Blocks\": 0,\n          \"Local Hit Blocks\": 0,\n          \"Local Read Blocks\": 0,\n          \"Local Dirtied Blocks\": 0,\n          \"Local Written Blocks\": 0,\n          \"Temp Read Blocks\": 0,\n          \"Temp Written Blocks\": 0,\n          \"Plans\": [\n            {\n              \"Node Type\": \"Sort\",\n              \"Parent Relationship\": \"Outer\",\n              \"Parallel Aware\": false,\n              \"Async Capable\": false,\n              \"Startup Cost\": 2631.69,\n              \"Total Cost\": 2656.69,\n              \"Plan Rows\": 10000,\n              \"Plan Width\": 62,\n              \"Actual Startup Time\": 23.980,\n              \"Actual Total Time\": 24.405,\n              \"Actual Rows\": 10000,\n              \"Actual Loops\": 1,\n              \"Sort Key\": [\"customer_totals.total_spent DESC\"],\n              \"Sort Method\": \"quicksort\",\n              \"Sort Space Used\": 953,\n              \"Sort Space Type\": \"Memory\",\n              \"Shared Hit Blocks\": 402,\n              \"Shared Read Blocks\": 112,\n              \"Shared Dirtied Blocks\": 0,\n              \"Shared Written Blocks\": 0,\n              \"Local Hit Blocks\": 0,\n              \"Local Read Blocks\": 0,\n              \"Local Dirtied Blocks\": 0,\n              \"Local Written Blocks\": 0,\n              \"Temp Read Blocks\": 0,\n              \"Temp Written Blocks\": 0,\n              \"Plans\": [\n                {\n                  \"Node Type\": \"Subquery Scan\",\n                  \"Parent Relationship\": \"Outer\",\n                  \"Parallel Aware\": false,\n                  \"Async Capable\": false,\n                  \"Alias\": \"customer_totals\",\n                  \"Startup Cost\": 1742.31,\n                  \"Total Cost\": 1967.31,\n                  \"Plan Rows\": 10000,\n                  \"Plan Width\": 62,\n                  \"Actual Startup Time\": 18.891,\n                  \"Actual Total Time\": 21.680,\n                  \"Actual Rows\": 10000,\n                  \"Actual Loops\": 1,\n                  \"Shared Hit Blocks\": 399,\n                  \"Shared Read Blocks\": 112,\n                  \"Shared Dirtied Blocks\": 0,\n                  \"Shared Written Blocks\": 0,\n                  \"Local Hit Blocks\": 0,\n                  \"Local Read Blocks\": 0,\n                  \"Local Dirtied Blocks\": 0,\n                  \"Local Written Blocks\": 0,\n                  \"Temp Read Blocks\": 0,\n                  \"Temp Written Blocks\": 0,\n                  \"Plans\": [\n                    {\n                      \"Node Type\": \"Aggregate\",\n                      \"Strategy\": \"Hashed\",\n                      \"Partial Mode\": \"Simple\",\n                      \"Parent Relationship\": \"Subquery\",\n                      \"Parallel Aware\": false,\n                      \"Async Capable\": false,\n                      \"Startup Cost\": 1742.31,\n                      \"Total Cost\": 1867.31,\n                      \"Plan Rows\": 10000,\n                      \"Plan Width\": 66,\n                      \"Actual Startup Time\": 18.890,\n                      \"Actual Total Time\": 21.061,\n                      \"Actual Rows\": 10000,\n                      \"Actual Loops\": 1,\n                      \"Group Key\": [\"c.id\"],\n                      \"Planned Partitions\": 0,\n                      \"HashAgg Batches\": 1,\n                      \"Peak Memory Usage\": 4753,\n                      \"Disk Usage\": 0,\n                      \"Shared Hit Blocks\": 399,\n                      \"Shared Read Blocks\": 112,\n                      \"Shared Dirtied Blocks\": 0,\n                      \"Shared Written Blocks\": 0,\n                      \"Local Hit Blocks\": 0,\n                      \"Local Read Blocks\": 0,\n                      \"Local Dirtied Blocks\": 0,\n                      \"Local Written Blocks\": 0,\n                      \"Temp Read Blocks\": 0,\n                      \"Temp Written Blocks\": 0,\n                      \"Plans\": [\n                        {\n                          \"Node Type\": \"Hash Join\",\n                          \"Parent Relationship\": \"Outer\",\n                          \"Parallel Aware\": false,\n                          \"Async Capable\": false,\n                          \"Join Type\": \"Right\",\n                          \"Startup Cost\": 339.00,\n                          \"Total Cost\": 1367.31,\n                          \"Plan Rows\": 50000,\n                          \"Plan Width\": 36,\n                          \"Actual Startup Time\": 2.100,\n                          \"Actual Total Time\": 11.428,\n                          \"Actual Rows\": 50000,\n                          \"Actual Loops\": 1,\n                          \"Inner Unique\": true,\n                          \"Hash Cond\": \"(o.customer_id = c.id)\",\n                          \"Shared Hit Blocks\": 399,\n                          \"Shared Read Blocks\": 112,\n                          \"Shared Dirtied Blocks\": 0,\n                          \"Shared Written Blocks\": 0,\n                          \"Local Hit Blocks\": 0,\n                          \"Local Read Blocks\": 0,\n                          \"Local Dirtied Blocks\": 0,\n                          \"Local Written Blocks\": 0,\n                          \"Temp Read Blocks\": 0,\n                          \"Temp Written Blocks\": 0,\n                          \"Plans\": [\n                            {\n                              \"Node Type\": \"Seq Scan\",\n                              \"Parent Relationship\": \"Outer\",\n                              \"Parallel Aware\": false,\n                              \"Async Capable\": false,\n                              \"Relation Name\": \"orders\",\n                              \"Alias\": \"o\",\n                              \"Startup Cost\": 0.00,\n                              \"Total Cost\": 897.00,\n                              \"Plan Rows\": 50000,\n                              \"Plan Width\": 14,\n                              \"Actual Startup Time\": 0.003,\n                              \"Actual Total Time\": 2.423,\n                              \"Actual Rows\": 50000,\n                              \"Actual Loops\": 1,\n                              \"Shared Hit Blocks\": 397,\n                              \"Shared Read Blocks\": 0,\n                              \"Shared Dirtied Blocks\": 0,\n                              \"Shared Written Blocks\": 0,\n                              \"Local Hit Blocks\": 0,\n                              \"Local Read Blocks\": 0,\n                              \"Local Dirtied Blocks\": 0,\n                              \"Local Written Blocks\": 0,\n                              \"Temp Read Blocks\": 0,\n                              \"Temp Written Blocks\": 0\n                            },\n                            {\n                              \"Node Type\": \"Hash\",\n                              \"Parent Relationship\": \"Inner\",\n                              \"Parallel Aware\": false,\n                              \"Async Capable\": false,\n                              \"Startup Cost\": 214.00,\n                              \"Total Cost\": 214.00,\n                              \"Plan Rows\": 10000,\n                              \"Plan Width\": 26,\n                              \"Actual Startup Time\": 2.075,\n                              \"Actual Total Time\": 2.076,\n                              \"Actual Rows\": 10000,\n                              \"Actual Loops\": 1,\n                              \"Hash Buckets\": 16384,\n                              \"Original Hash Buckets\": 16384,\n                              \"Hash Batches\": 1,\n                              \"Original Hash Batches\": 1,\n                              \"Peak Memory Usage\": 707,\n                              \"Shared Hit Blocks\": 2,\n                              \"Shared Read Blocks\": 112,\n                              \"Shared Dirtied Blocks\": 0,\n                              \"Shared Written Blocks\": 0,\n                              \"Local Hit Blocks\": 0,\n                              \"Local Read Blocks\": 0,\n                              \"Local Dirtied Blocks\": 0,\n                              \"Local Written Blocks\": 0,\n                              \"Temp Read Blocks\": 0,\n                              \"Temp Written Blocks\": 0,\n                              \"Plans\": [\n                                {\n                                  \"Node Type\": \"Seq Scan\",\n                                  \"Parent Relationship\": \"Outer\",\n                                  \"Parallel Aware\": false,\n                                  \"Async Capable\": false,\n                                  \"Relation Name\": \"customers\",\n                                  \"Alias\": \"c\",\n                                  \"Startup Cost\": 0.00,\n                                  \"Total Cost\": 214.00,\n                                  \"Plan Rows\": 10000,\n                                  \"Plan Width\": 26,\n                                  \"Actual Startup Time\": 0.006,\n                                  \"Actual Total Time\": 1.008,\n                                  \"Actual Rows\": 10000,\n                                  \"Actual Loops\": 1,\n                                  \"Shared Hit Blocks\": 2,\n                                  \"Shared Read Blocks\": 112,\n                                  \"Shared Dirtied Blocks\": 0,\n                                  \"Shared Written Blocks\": 0,\n                                  \"Local Hit Blocks\": 0,\n                                  \"Local Read Blocks\": 0,\n                                  \"Local Dirtied Blocks\": 0,\n                                  \"Local Written Blocks\": 0,\n                                  \"Temp Read Blocks\": 0,\n                                  \"Temp Written Blocks\": 0\n                                }\n                              ]\n                            }\n                          ]\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      ]\n    },\n    \"Planning\": {\n      \"Shared Hit Blocks\": 213,\n      \"Shared Read Blocks\": 3,\n      \"Shared Dirtied Blocks\": 0,\n      \"Shared Written Blocks\": 0,\n      \"Local Hit Blocks\": 0,\n      \"Local Read Blocks\": 0,\n      \"Local Dirtied Blocks\": 0,\n      \"Local Written Blocks\": 0,\n      \"Temp Read Blocks\": 0,\n      \"Temp Written Blocks\": 0\n    },\n    \"Planning Time\": 0.647,\n    \"Triggers\": [\n    ],\n    \"Execution Time\": 25.432\n  }\n]"
}
